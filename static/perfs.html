<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ECharts</title>
    <script src="echarts.min.js"></script>
    <script src="jquery-2.2.4.js"></script>
</head>
<body>
    <div id="CPU" style="width:100%;height:1200px;padding:0 5%;"></div><hr>
    <div id="RAM" style="width:100%;height:320px;padding:0 5%;"></div><hr>
    <div id="DISK" style="width:100%;height:320px;padding:0 5%;"></div><hr>
    <div id="NET" style="width:100%;height:320px;padding:0 5%;"></div>
<script>
  $(function(){
    $('#project_nav').addClass('active');

    var cpuChart = echarts.init(document.getElementById('CPU'));
    var ramChart = echarts.init(document.getElementById('RAM'));
    var diskChart = echarts.init(document.getElementById('DISK'));
    var netChart = echarts.init(document.getElementById('NET'));

    function getCpuOption(data) {
        var series = []
        var grid = []
        var xAxis = []
        var yAxis = []
        var legend = []
        
        var keys = Object.keys(data.data).sort()

        for(var i = 0, k; k = keys[i]; i++) {
            for(var j = 0, key; key = Object.keys(data.data[k]).sort()[j]; j++) {
                var v = {
                    name: key,
                    type: 'line',
                    stack: '',
                    xAxisIndex: i,
                    yAxisIndex: i,
                    symbol: 'none',
                    smooth: true,
                    stack: k,
                    lineStyle: {
                        normal: {
                            width: 0
                        }
                    },
                    data: data.data[k][key]
                }
                switch(key) {
                    case 'steal':
                        v.itemStyle = {normal: {
                            color: '#91c7ae',
                            areaStyle: {
                                color: '#91c7ae',
                            }
                        }}
                        series.push(v)
                        break
                    case 'softirq':
                        v.itemStyle = {normal: {
                            color: '#d48265',
                            areaStyle: {
                                color: '#d48265',
                            }
                        }}
                        series.push(v)
                        break
                    case 'user':
                        v.itemStyle = {normal: {
                            color: '#2f4554',
                            areaStyle: {
                                color: '#2f4554',
                            }
                        }}
                        series.push(v)
                        break
                    case 'system':
                        v.itemStyle = {normal: {
                            color: '#c23531',
                            areaStyle: {
                                color: '#c23531'
                            }
                        }}
                        series.push(v)
                        break
                    case 'nice':
                        v.itemStyle = {normal: {
                            color: '#61a0a8',
                            areaStyle: {
                                color: '#61a0a8',
                            }
                        }}
                        series.push(v)
                        break
                    case 'iowait':
                        v.itemStyle = {normal: {
                            color: '#749f83',
                            areaStyle: {
                                color: '#749f83',
                            }
                        }}
                        series.push(v)
                }
                
            }
        }

        for(var i = 0, k; k = keys[i]; i++) {
            grid.push({
                left: 50,
                right: 50,
                top: i * 20 + 5 + '%',
                height: '10%',
                width: '85%',
            })

            xAxis.push({
                gridIndex: i,
                type: 'category',
                splitLine: {show: false},
                boundaryGap: true,
                data: data.xAxis
            })

            yAxis.push({
                gridIndex: i,
                name: k,
                type: 'value',
                splitLine: {show: false},
            })

            legend.push({
                data:[
                        {name:'steal', icon:'bar'},  //, textStyle: {color: 'rgb(51, 102, 204)'}
                        {name:'softirq', icon:'bar'},  //, textStyle: {color: 'rgb(214, 99, 0)'}
                        {name:'user', icon:'bar'},  //, textStyle: {color: 'rgb(221, 221, 0)'}
                        {name:'system', icon:'bar'},  //, textStyle: {color: 'rgb(59, 62, 172)'}
                        {name:'nice', icon:'bar'},  //, textStyle: {color: 'rgb(238, 153, 17)'}
                        {name:'iowait', icon:'bar'}  //, textStyle: {color: 'rgb(187, 68, 204)'}
                    ],
                orient:'vertical',
                x:'right',
                top: i * 20 + 5 + '%',
                index: i,
                
            })
        }

        var option = {
            title: {
                text: 'CPU'
            },
            legend: legend,
            toolbox: {
                show: true,
                feature: {
                    saveAsImage: {show: true}
                }
            },
            tooltip: {
                 trigger: 'axis',
                axisPointer: {
                    animation: false
                }
            },
            grid: grid,
            xAxis: xAxis,
            yAxis: yAxis,
            series: series
        }
        return option

    }

    function setCpu(data) {
        var option = getCpuOption(data);
        cpuChart.setOption(option);
    }

    function setRam(data) {
        var option = {
            title: {
                text: 'RAM'
            },
            tooltip: {},
            legend: {
                data:['buffers', 'cached', 'memFree', 'memTotal', 'swapFree', 'swapTotal'],
                orient:'vertical',
                x:'right',
                top: '30%',
            },
            toolbox: {
                show: true,
                feature: {
                    saveAsImage: {show: true}
                }
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                splitLine: {show: false},
                data: data.xAxis
            },
            yAxis: {
                type: 'value',
                splitLine: {show: false},
                boundaryGap: [0, '60%']
            },
            tooltip: {
                trigger: 'axis',
                position: function (pt) {
                    return [pt[0], '10%'];
                }
            },
            series: [{
                name: 'buffers',
                type: 'line',
                symbol: 'none',
                stack: 'mem',
                areaStyle: {normal: {}},
                lineStyle: {
                    normal: {
                        width: 0
                    }
                },
                data: data.data.buffers
            },
            {
                name: 'cached',
                type: 'line',
                symbol: 'none',
                stack: 'mem',
                areaStyle: {normal: {}},
                lineStyle: {
                    normal: {
                        width: 0
                    }
                },
                data: data.data.cached
            },
            {
                name: 'memFree',
                type: 'line',
                symbol: 'none',
                stack: 'mem',
                areaStyle: {normal: {}},
                lineStyle: {
                    normal: {
                        width: 0
                    }
                },
                data: data.data.memFree
            },
            {
                name: 'memTotal',
                type: 'line',
                symbol: 'none',
                stack: 'mem',
                areaStyle: {normal: {}},
                lineStyle: {
                    normal: {
                        width: 0
                    }
                },
                data: data.data.memTotal
            },
            {
                name: 'swapFree',
                type: 'line',
                symbol: 'none',
                stack: 'mem',
                areaStyle: {normal: {}},
                lineStyle: {
                    normal: {
                        width: 0
                    }
                },
                data: data.data.swapFree
            },
            {
                name: 'swapTotal',
                type: 'line',
                symbol: 'none',
                stack: 'mem',
                areaStyle: {normal: {}},
                lineStyle: {
                    normal: {
                        width: 0
                    }
                },
                data: data.data.swapTotal
            }]
        };

        ramChart.setOption(option);
    }

    function setDisk(data) {
        var option = {
            title: {
                text: 'DISK'
            },
            tooltip: {},
            legend: {
                data:['read', 'write'],
                orient:'vertical',
                x:'right',
                top: '30%',
            },
            toolbox: {
                show: true,
                feature: {
                    saveAsImage: {show: true}
                }
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                splitLine: {show: false},
                data: data.xAxis
            },
            yAxis: {
                type: 'value',
                boundaryGap: [0, '60%'],
                splitLine: {show: false},
            },
            tooltip: {
                trigger: 'axis',
                position: function (pt) {
                    return [pt[0], '10%'];
                }
            },
            series: [{
                name: 'read',
                type: 'line',
                symbol: 'none',
                smooth: true,
                stack: 'disk',
                areaStyle: {normal: {}},
                lineStyle: {
                    normal: {
                        width: 0
                    }
                },
                data: data.data.read
            },
            {
                name: 'write',
                type: 'line',
                symbol: 'none',
                smooth: true,
                stack: 'disk',
                areaStyle: {normal: {}},
                lineStyle: {
                    normal: {
                        width: 0
                    }
                },
                data: data.data.write
            }]
        };

        diskChart.setOption(option);
    }

    function setNet(data) {
        var option = {
            title: {
                text: 'NET'
            },
            tooltip: {},
            legend: {
                data:['send', 'receive'],
                orient:'vertical',
                x:'right',
                top: '30%',
            },
            toolbox: {
                show: true,
                feature: {
                    saveAsImage: {show: true}
                }
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                splitLine: {show: false},
                data: data.xAxis
            },
            yAxis: {
                type: 'value',
                boundaryGap: [0, '60%'],
                splitLine: {show: false},
            },
            tooltip: {
                trigger: 'axis',
                position: function (pt) {
                    return [pt[0], '10%'];
                }
            },
            series: [{
                name: 'receive',
                type: 'line',
                symbol: 'none',
                smooth: true,
                stack: 'net',
                areaStyle: {normal: {}},
                lineStyle: {
                    normal: {
                        width: 0
                    }
                },
                data: data.data.receive
            },
            {
                name: 'send',
                type: 'line',
                symbol: 'none',
                smooth: true,
                stack: 'net',
                areaStyle: {normal: {}},
                lineStyle: {
                    normal: {
                        width: 0
                    }
                },
                data: data.data.send
            }]
        };

        netChart.setOption(option);
    }
 

    
    var socket;
    socket = new WebSocket('ws://tars.nie.netease.com:9002')
    socket.onopen = function(event) {
        console.log("onopen")
    }

    var cpu_data = {xAxis:[], data:{}}
    var mem_data = {xAxis:[], data:{buffers:[], cached:[], memFree:[], memTotal:[], swapFree:[], swapTotal:[]}};
    var disk_data = {xAxis:[], data:{read:[], write:[]}};
    var net_data = {xAxis:[], data:{receive:[], send:[]}};

    function dataToString(date){
        var dateStr = date.getFullYear() + '-' + ('0' + (date.getMonth() + 1)).slice(-2) + '-' + ('0' + date.getDate()).slice(-2) + ' ' + ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2);
        return dateStr;
    }

    socket.onmessage = function(event) {
        data = JSON.parse(event.data)
        console.log(data)
        if(data.type == 'cpu') {
            cpu_data.xAxis.push(dataToString(new Date(parseInt(data.time) * 1000)));
            for (var key in data) {
                if(key.startsWith('cpu')) {
                    if(!cpu_data.data[key]) {
                        cpu_data.data[key] = []
                    }
                    for(var cpu_key in data[key]) {
                        if(!cpu_data.data[key][cpu_key]) {
                            cpu_data.data[key][cpu_key] = []
                        }
                        cpu_data.data[key][cpu_key].push(data[key][cpu_key])
                    }
                }

            }

            setCpu(cpu_data);
        } else if(data.type == 'mem') {
            mem_data.xAxis.push(dataToString(new Date(parseInt(data.time) * 1000)));
            mem_data.data.buffers.push(data.buffers);
            mem_data.data.cached.push(data.cached);
            mem_data.data.memFree.push(data.memFree);
            mem_data.data.memTotal.push(data.memTotal);
            mem_data.data.swapFree.push(data.swapFree);
            mem_data.data.swapTotal.push(data.swapTotal);
            setRam(mem_data);
        } else if(data.type == 'disk') {
            disk_data.xAxis.push(dataToString(new Date(parseInt(data.time) * 1000)));
            disk_data.data.read.push(data.read);
            disk_data.data.write.push(data.write);
            setDisk(disk_data);
        } else if(data.type == 'net') {
            net_data.xAxis.push(dataToString(new Date(parseInt(data.time) * 1000)));
            net_data.data.receive.push(data.receive);
            net_data.data.send.push(data.send);
            setNet(net_data);
        }

    }

    socket.onclose = function(event) {
        console.log("onclose")
    }

    console.log(socket);
  });
</script>
</body>
</html>
